<!DOCTYPE html>
<html lang="{{ current_lang }}">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>{{ translations.site_name }} - {{ translations.title }}</title>
		<link
			href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
			rel="stylesheet"
		/>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	</head>
	<body class="bg-gray-100 min-h-screen">
		<div class="container mx-auto px-4 py-8">
			<!-- Dil seçici -->
			<div class="flex justify-end mb-4 space-x-2">
				{% for lang in languages %}
				<a
					href="/{{ lang.code }}"
					class="inline-flex items-center px-3 py-2 border rounded-md {% if current_lang == lang.code %}bg-purple-600 text-white{% else %}bg-white text-gray-700{% endif %} hover:bg-purple-500 hover:text-white transition-colors duration-200"
				>
					<span class="mr-2">{{ lang.flag }}</span>
					<span>{{ lang.name }}</span>
				</a>
				{% endfor %}
			</div>

			<div class="max-w-3xl mx-auto">
				<h1 class="text-4xl font-bold text-center mb-2 text-purple-600">
					{{ translations.title }}
				</h1>
				<p class="text-center text-gray-600 mb-8">{{ translations.subtitle }}</p>
				
				<div class="bg-white rounded-lg shadow-lg p-6">
					<div class="mb-6">
						<label
							class="block text-gray-700 text-sm font-bold mb-2"
							for="instagram-url"
						>
							{{ translations.input_placeholder }}
						</label>
						<input
							type="text"
							id="instagram-url"
							class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
							placeholder="{{ translations.input_placeholder }}"
						/>
					</div>
					
					<div class="mb-6">
						<label class="block text-gray-700 text-sm font-bold mb-2">Medya Tipi</label>
						<div class="flex space-x-4">
							<label class="inline-flex items-center">
								<input
									type="radio"
									name="type"
									value="post"
									checked
									class="form-radio text-purple-600"
								/>
								<span class="ml-2">Post</span>
							</label>
							<label class="inline-flex items-center">
								<input
									type="radio"
									name="type"
									value="reel"
									class="form-radio text-purple-600"
								/>
								<span class="ml-2">Reel</span>
							</label>
							<label class="inline-flex items-center">
								<input
									type="radio"
									name="type"
									value="story"
									class="form-radio text-purple-600"
								/>
								<span class="ml-2">Story</span>
							</label>
						</div>
					</div>

					<!-- Story seçim bölümü -->
					<div id="story-selector" class="mb-6 hidden">
						<label class="block text-gray-700 text-sm font-bold mb-2">
							{{ translations.story_selector_title }}
						</label>
						<div id="story-list" class="grid grid-cols-2 gap-4 mt-2">
							<!-- Story'ler buraya dinamik olarak eklenecek -->
						</div>
					</div>

					<!-- Post/Reel önizleme bölümü -->
					<div id="preview-section" class="mb-6 hidden">
						<div class="bg-white rounded-lg shadow-md p-4">
							<div class="flex flex-col md:flex-row md:items-start gap-4">
								<div class="w-full md:w-2/5 lg:w-1/3">
									<img 
										id="preview-image" 
										src="" 
										alt="Preview" 
										class="w-full h-auto rounded-lg"
										style="max-height: 300px; object-fit: cover;"
									/>
									<div id="preview-type-badge" class="mt-2 inline-block bg-purple-600 text-white text-xs px-2 py-1 rounded-full"></div>
								</div>
								<div class="flex-1">
									<div class="flex items-center space-x-2 mb-2">
										<span id="preview-owner" class="font-semibold text-base"></span>
										<span class="text-gray-500">•</span>
										<span id="preview-timestamp" class="text-gray-500 text-sm"></span>
									</div>
									<p id="preview-caption" class="text-sm text-gray-600 mb-4 line-clamp-3"></p>
									<div class="flex items-center space-x-6 text-sm text-gray-500">
										<span id="preview-likes" class="flex items-center">
											<svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
											</svg>
											<span class="font-medium"></span>
										</span>
										<span id="preview-comments" class="flex items-center">
											<svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
											</svg>
											<span class="font-medium"></span>
										</span>
									</div>
								</div>
							</div>
						</div>
					</div>

					<button
						id="download-btn"
						class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200"
					>
						{{ translations.download_button }}
					</button>

					<div id="status" class="mt-4 hidden">
						<div class="animate-pulse flex space-x-4">
							<div class="flex-1 space-y-4 py-1">
								<div class="h-4 bg-purple-200 rounded w-3/4"></div>
							</div>
						</div>
					</div>

					<div id="result" class="mt-4 hidden">
						<div
							class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4"
							role="alert"
						>
							<p class="font-bold">{{ translations.success_text }}</p>
							<p>
								{{ translations.download_start_text }}
								<a href="#" id="download-link" class="underline">{{ translations.click_here }}</a>
							</p>
						</div>
					</div>

					<div id="error" class="mt-4 hidden">
						<div
							class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4"
							role="alert"
						>
							<p class="font-bold">{{ translations.error_text }}</p>
							<p id="error-message"></p>
						</div>
					</div>
				</div>

				<!-- Nasıl kullanılır bölümü -->
				<div class="mt-12">
					<h2 class="text-2xl font-bold mb-4">{{ translations.how_to_title }}</h2>
					<div class="bg-white rounded-lg shadow-lg p-6">
						<div class="mb-6">
							<h3 class="text-lg font-semibold mb-2">{{ translations.how_to_step1 }}</h3>
							<p class="text-gray-600">{{ translations.how_to_step1_desc }}</p>
						</div>
					</div>
				</div>

				<!-- SSS bölümü -->
				<div class="mt-12">
					<h2 class="text-2xl font-bold mb-4">{{ translations.faq_title }}</h2>
					<div class="bg-white rounded-lg shadow-lg p-6">
						<p class="text-gray-600">{{ translations.faq_desc }}</p>
					</div>
				</div>
			</div>
		</div>

		<script>
			const downloadBtn = document.getElementById("download-btn");
			const urlInput = document.getElementById("instagram-url");
			const statusDiv = document.getElementById("status");
			const resultDiv = document.getElementById("result");
			const errorDiv = document.getElementById("error");
			const downloadLink = document.getElementById("download-link");
			const errorMessage = document.getElementById("error-message");
			const storySelector = document.getElementById("story-selector");
			const storyList = document.getElementById("story-list");
			
			// Story seçildiğinde göster/gizle
			document.querySelectorAll('input[name="type"]').forEach((radio) => {
				radio.addEventListener('change', (e) => {
					const urlInput = document.getElementById('instagram-url');
					
					// Placeholder'ı seçilen tipe göre güncelle
					switch(e.target.value) {
						case 'story':
							urlInput.placeholder = 'https://www.instagram.com/stories/username/';
							storySelector.classList.remove('hidden');
							break;
						case 'post':
							urlInput.placeholder = 'https://www.instagram.com/p/...';
							storySelector.classList.add('hidden');
							break;
						case 'reel':
							urlInput.placeholder = 'https://www.instagram.com/reel/...';
							storySelector.classList.add('hidden');
							break;
					}
				});
			});
			
			function extractUsername(url) {
				if (!url) return null;
				
				// URL'yi temizle ve normalize et
				url = url.trim().replace(/\/$/, '');
				
				// Farklı URL formatlarını kontrol et
				const patterns = [
					/instagram\.com\/stories\/([^/?]+)/,  // stories/username/ veya stories/username/story_id
					/instagram\.com\/([^/?]+)/,           // doğrudan username
				];
				
				for (const pattern of patterns) {
					const match = url.match(pattern);
					if (match && match[1]) {
						// Kullanıcı adını döndür
						return match[1];
					}
				}
				
				return null;
			}
			
			async function fetchStories(username) {
				try {
					statusDiv.classList.remove('hidden');
					storyList.innerHTML = '';
					errorDiv.classList.add('hidden');
					
					const response = await axios.get(`/api/stories/${username}`);
					console.log('Story response:', response.data); // Debug için
					
					if (response.data.success) {
						const stories = response.data.stories;
						if (stories.length === 0) {
							showError('Kullanıcının aktif story\'si bulunmuyor');
							return;
						}
						
						stories.forEach(story => {
							console.log('Story item:', story); // Her story için debug
							const storyElement = document.createElement('div');
							storyElement.className = 'border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition duration-200 shadow-sm';
							
							// Önizleme URL'sini proxy üzerinden al
							const previewUrl = story.thumbnail || story.url;
							const proxiedUrl = `/api/proxy-image?url=${encodeURIComponent(previewUrl)}`;
							console.log('Proxied URL:', proxiedUrl); // Debug için
							
							// Thumbnail ve içerik için container
							const contentHtml = `
								<div class="flex flex-col">
									<div class="relative mb-3 rounded-lg overflow-hidden bg-gray-100" style="aspect-ratio: 9/16;">
										<img 
											src="${proxiedUrl}"
											alt="Story önizleme"
											class="absolute inset-0 w-full h-full object-cover"
											onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjcxMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPsOWbml6bGVtZSBZw7xrbGVuZW1lZGk8L3RleHQ+PC9zdmc+'"
										/>
										<div class="absolute inset-0 bg-black bg-opacity-20"></div>
										<div class="absolute top-2 right-2">
											${story.type === 'video' 
												? '<span class="bg-purple-600 text-white text-xs px-2 py-1 rounded-full"><svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></span>'
												: '<span class="bg-purple-600 text-white text-xs px-2 py-1 rounded-full"><svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></span>'
											}
										</div>
									</div>
									<div class="flex items-center justify-between">
										<div class="flex-1">
											<p class="text-sm text-gray-500">
												${new Date(story.timestamp).toLocaleString('tr-TR', {
													hour: '2-digit',
													minute: '2-digit',
													day: '2-digit',
													month: '2-digit'
												})}
											</p>
										</div>
										<button 
											onclick="downloadStory('${story.url}')"
											class="ml-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200 flex items-center space-x-1"
										>
											<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
											</svg>
											<span>İndir</span>
										</button>
									</div>
								</div>
							`;
							
							storyElement.innerHTML = contentHtml;
							storyList.appendChild(storyElement);
							
							// Resim yüklenme durumunu kontrol et
							const img = storyElement.querySelector('img');
							img.addEventListener('load', () => {
								console.log('Image loaded successfully:', proxiedUrl);
							});
							img.addEventListener('error', () => {
								console.error('Image failed to load:', proxiedUrl);
							});
						});
					}
				} catch (error) {
					console.error('Story fetch error:', error);
					showError(error.response?.data?.detail || 'Story\'ler alınamadı');
				} finally {
					statusDiv.classList.add('hidden');
				}
			}
			
			function downloadStory(url) {
				downloadMedia(url);
			}

			function downloadMedia(url) {
				window.location.href = `/api/download-media?url=${encodeURIComponent(url)}`;
			}

			// Manuel indirme linki için click event'i
			downloadLink.addEventListener("click", (e) => {
				e.preventDefault();
				const url = downloadLink.href;
				downloadMedia(url);
			});

			// URL input değişikliğini dinle - otomatik search'ü kaldır
			urlInput.addEventListener('input', (e) => {
				const url = e.target.value.trim();
				const type = document.querySelector('input[name="type"]:checked').value;
				downloadBtn.disabled = !url;
				
				// Story seçiliyse önizleme gösterme
				if (type === 'story') {
					document.getElementById('preview-section').classList.add('hidden');
				}
				
				// URL boşsa önizlemeyi gizle
				if (!url) {
					document.getElementById('preview-section').classList.add('hidden');
				}
			});

			// Sayıları formatlama fonksiyonu
			function formatNumber(num) {
				if (num >= 1000000) {
					return (num / 1000000).toFixed(1) + 'M';
				}
				if (num >= 1000) {
					return (num / 1000).toFixed(1) + 'K';
				}
				return num.toString();
			}

			// Tarihi formatlama fonksiyonu
			function formatDate(isoDate) {
				const date = new Date(isoDate);
				const now = new Date();
				const diff = now - date;
				
				// 1 saatten az
				if (diff < 3600000) {
					const minutes = Math.floor(diff / 60000);
					return `${minutes}m`;
				}
				// 1 günden az
				if (diff < 86400000) {
					const hours = Math.floor(diff / 3600000);
					return `${hours}h`;
				}
				// 1 haftadan az
				if (diff < 604800000) {
					const days = Math.floor(diff / 86400000);
					return `${days}d`;
				}
				// Diğer durumlar
				return date.toLocaleDateString();
			}

			// Loading state yönetimi için fonksiyonlar
			function showLoading(message) {
				statusDiv.classList.remove('hidden');
				resultDiv.classList.add('hidden');
				errorDiv.classList.add('hidden');
				downloadBtn.disabled = true;
			}

			function hideLoading() {
				statusDiv.classList.add('hidden');
				downloadBtn.disabled = false;
			}

			function displayStories(stories) {
				storyList.innerHTML = ''; // Önceki story'leri temizle
				storySelector.classList.remove('hidden');
				
				stories.forEach(story => {
					const storyElement = document.createElement('div');
					storyElement.className = 'border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition duration-200 shadow-sm';
					
					// Önizleme URL'sini proxy üzerinden al
					const previewUrl = story.thumbnail || story.url;
					const proxiedUrl = `/api/proxy-image?url=${encodeURIComponent(previewUrl)}`;
					
					// Thumbnail ve içerik için container
					const contentHtml = `
						<div class="flex flex-col">
							<div class="relative mb-3 rounded-lg overflow-hidden bg-gray-100" style="aspect-ratio: 9/16;">
								<img 
									src="${proxiedUrl}"
									alt="Story önizleme"
									class="absolute inset-0 w-full h-full object-cover"
									onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjcxMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPsOWbml6bGVtZSBZw7xrbGVuZW1lZGk8L3RleHQ+PC9zdmc+'"
								/>
								<div class="absolute inset-0 bg-black bg-opacity-20"></div>
								<div class="absolute top-2 right-2">
									${story.type === 'video' 
										? '<span class="bg-purple-600 text-white text-xs px-2 py-1 rounded-full"><svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></span>'
										: '<span class="bg-purple-600 text-white text-xs px-2 py-1 rounded-full"><svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></span>'
									}
								</div>
							</div>
							<div class="flex items-center justify-between">
								<div class="flex-1">
									<p class="text-sm text-gray-500">
										${new Date(story.timestamp).toLocaleString('tr-TR', {
											hour: '2-digit',
											minute: '2-digit',
											day: '2-digit',
											month: '2-digit'
										})}
									</p>
								</div>
								<button 
									onclick="downloadStory('${story.url}')"
									class="ml-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200 flex items-center space-x-1"
								>
									<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
										<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
									</svg>
									<span>İndir</span>
								</button>
							</div>
						</div>
					`;
					
					storyElement.innerHTML = contentHtml;
					storyList.appendChild(storyElement);
				});
			}

			// Download butonu click event'i
			downloadBtn.addEventListener("click", async () => {
				const url = urlInput.value.trim();
				const type = document.querySelector('input[name="type"]:checked').value;

				if (!url) {
					showError("Lütfen bir Instagram URL'si girin");
					return;
				}

				try {
					showLoading('Yükleniyor...');
					
					if (type === 'story') {
						const username = extractUsername(url);
						if (!username) {
							showError("Geçerli bir Instagram URL'si değil");
							hideLoading();
							return;
						}

						// Story'leri getir
						const response = await axios.get(`/api/stories/${username}`);
						
						if (response.data.success) {
							const stories = response.data.stories;
							if (stories.length > 0) {
								displayStories(stories);
							} else {
								showError('Kullanıcının aktif story\'si bulunmuyor');
							}
						} else {
							showError(response.data.message || 'Story\'ler alınamadı');
						}
					} else {
						// Önce önizleme al
						try {
							const previewResponse = await axios.get(`/api/preview?url=${encodeURIComponent(url)}`);
							const preview = previewResponse.data;
							
							// Önizleme bölümünü göster ve doldur
							document.getElementById('preview-section').classList.remove('hidden');
							
							// Resmi yükle
							const previewImage = document.getElementById('preview-image');
							const proxyUrl = `/api/proxy-image?url=${encodeURIComponent(preview.thumbnail)}`;
							previewImage.src = proxyUrl;
							
							// Diğer bilgileri doldur
							document.getElementById('preview-type-badge').innerHTML = preview.type === 'video' ? 
								'<svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' :
								'<svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>';
							
							document.getElementById('preview-owner').textContent = preview.owner;
							document.getElementById('preview-caption').textContent = preview.caption;
							document.getElementById('preview-likes').querySelector('span').textContent = formatNumber(preview.likes);
							document.getElementById('preview-comments').querySelector('span').textContent = formatNumber(preview.comments);
							document.getElementById('preview-timestamp').textContent = formatDate(preview.timestamp);
							
							// Medyayı indir
							await downloadMedia(url);
							resultDiv.classList.remove('hidden');
							
						} catch (previewError) {
							console.error('Preview error:', previewError);
							showError(previewError.response?.data?.detail || "Önizleme alınamadı");
						}
					}
				} catch (error) {
					console.error('Error:', error);
					showError(error.response?.data?.detail || "Bir hata oluştu");
				} finally {
					hideLoading();
				}
			});

			function showError(message) {
				errorMessage.textContent = message;
				statusDiv.classList.add("hidden");
				resultDiv.classList.add("hidden");
				errorDiv.classList.remove("hidden");
			}
		</script>
	</body>
</html>
