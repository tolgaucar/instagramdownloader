<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>instatest - Instagram Media Downloader</title>
		<link
			href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
			rel="stylesheet"
		/>
		<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
	</head>
	<body class="bg-gray-100 min-h-screen">
		<div class="container mx-auto px-4 py-8">
			<div class="max-w-3xl mx-auto">
				<h1 class="text-4xl font-bold text-center mb-2 text-purple-600">
					test
				</h1>
				<p class="text-center text-gray-600 mb-8">Instagram Media Downloader</p>
				
				<div class="bg-white rounded-lg shadow-lg p-6">
					<div class="mb-6">
						<label
							class="block text-gray-700 text-sm font-bold mb-2"
							for="instagram-url"
						>
							Instagram URL'si
						</label>
						<input
							type="text"
							id="instagram-url"
							class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-600"
							placeholder="https://www.instagram.com/p/..."
						/>
					</div>
					
					<div class="mb-6">
						<label class="block text-gray-700 text-sm font-bold mb-2">Medya Tipi</label>
						<div class="flex space-x-4">
							<label class="inline-flex items-center">
								<input
									type="radio"
									name="type"
									value="post"
									checked
									class="form-radio text-purple-600"
								/>
								<span class="ml-2">Post</span>
							</label>
							<label class="inline-flex items-center">
								<input
									type="radio"
									name="type"
									value="reel"
									class="form-radio text-purple-600"
								/>
								<span class="ml-2">Reel</span>
							</label>
							<label class="inline-flex items-center">
								<input
									type="radio"
									name="type"
									value="story"
									class="form-radio text-purple-600"
								/>
								<span class="ml-2">Story</span>
							</label>
						</div>
					</div>

					<!-- Story seçim bölümü -->
					<div id="story-selector" class="mb-6 hidden">
						<label class="block text-gray-700 text-sm font-bold mb-2">
							Kullanıcının Story'leri
						</label>
						<div id="story-list" class="grid grid-cols-2 gap-4 mt-2">
							<!-- Story'ler buraya dinamik olarak eklenecek -->
						</div>
					</div>

					<button
						id="download-btn"
						class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition duration-200"
					>
						İndir
					</button>

					<div id="status" class="mt-4 hidden">
						<div class="animate-pulse flex space-x-4">
							<div class="flex-1 space-y-4 py-1">
								<div class="h-4 bg-purple-200 rounded w-3/4"></div>
							</div>
						</div>
					</div>

					<div id="result" class="mt-4 hidden">
						<div
							class="bg-green-100 border-l-4 border-green-500 text-green-700 p-4"
							role="alert"
						>
							<p class="font-bold">Başarılı!</p>
							<p>
								İndirme işlemi başladı. Eğer indirme başlamazsa
								<a href="#" id="download-link" class="underline">buraya tıklayın</a>
							</p>
						</div>
					</div>

					<div id="error" class="mt-4 hidden">
						<div
							class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4"
							role="alert"
						>
							<p class="font-bold">Hata</p>
							<p id="error-message"></p>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script>
			const downloadBtn = document.getElementById("download-btn");
			const urlInput = document.getElementById("instagram-url");
			const statusDiv = document.getElementById("status");
			const resultDiv = document.getElementById("result");
			const errorDiv = document.getElementById("error");
			const downloadLink = document.getElementById("download-link");
			const errorMessage = document.getElementById("error-message");
			const storySelector = document.getElementById("story-selector");
			const storyList = document.getElementById("story-list");
			
			// Story seçildiğinde göster/gizle
			document.querySelectorAll('input[name="type"]').forEach((radio) => {
				radio.addEventListener('change', (e) => {
					const urlInput = document.getElementById('instagram-url');
					
					// Placeholder'ı seçilen tipe göre güncelle
					switch(e.target.value) {
						case 'story':
							urlInput.placeholder = 'https://www.instagram.com/stories/username/';
							storySelector.classList.remove('hidden');
							// URL'den kullanıcı adını al ve story'leri getir
							const username = extractUsername(urlInput.value);
							if (username) {
								fetchStories(username);
							}
							break;
						case 'post':
							urlInput.placeholder = 'https://www.instagram.com/p/...';
							storySelector.classList.add('hidden');
							break;
						case 'reel':
							urlInput.placeholder = 'https://www.instagram.com/reel/...';
							storySelector.classList.add('hidden');
							break;
					}
				});
			});
			
			function extractUsername(url) {
				if (!url) return null;
				
				// URL'yi temizle ve normalize et
				url = url.trim().replace(/\/$/, '');
				
				// Farklı URL formatlarını kontrol et
				const patterns = [
					/instagram\.com\/stories\/([^/?]+)/,  // stories/username/ veya stories/username/story_id
					/instagram\.com\/([^/?]+)/,           // doğrudan username
				];
				
				for (const pattern of patterns) {
					const match = url.match(pattern);
					if (match && match[1]) {
						// Kullanıcı adını döndür
						return match[1];
					}
				}
				
				return null;
			}
			
			async function fetchStories(username) {
				try {
					statusDiv.classList.remove('hidden');
					storyList.innerHTML = '';
					errorDiv.classList.add('hidden');
					
					const response = await axios.get(`/api/stories/${username}`, {
						timeout: 60000 // 60 saniye timeout
					});
					
					if (response.data.success) {
						const stories = response.data.stories;
						if (stories.length === 0) {
							showError('Kullanıcının aktif story\'si bulunmuyor');
							return;
						}
						
						// Story seçim alanını göster
						document.getElementById('story-selector').style.display = 'block';
						
						stories.forEach(story => {
							const storyElement = document.createElement('div');
							storyElement.className = 'border rounded-lg p-4 cursor-pointer hover:bg-gray-50 transition duration-200 shadow-sm';
							
							// Önizleme URL'sini proxy üzerinden al
							const previewUrl = story.thumbnail || story.url;
							const proxiedUrl = `/api/proxy-image?url=${encodeURIComponent(previewUrl)}`;
							
							// Thumbnail ve içerik için container
							const contentHtml = `
								<div class="flex flex-col">
									<div class="relative mb-3 rounded-lg overflow-hidden bg-gray-100" style="aspect-ratio: 9/16;">
										<img 
											src="${proxiedUrl}"
											alt="Story önizleme"
											class="absolute inset-0 w-full h-full object-cover"
											onerror="this.onerror=null; this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjcxMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyMCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPsOWbml6bGVtZSBZw7xrbGVuZW1lZGk8L3RleHQ+PC9zdmc+'"
										/>
										<div class="absolute inset-0 bg-black bg-opacity-20"></div>
										<div class="absolute top-2 right-2">
											${story.type === 'video' 
												? '<span class="bg-purple-600 text-white text-xs px-2 py-1 rounded-full"><svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></span>'
												: '<span class="bg-purple-600 text-white text-xs px-2 py-1 rounded-full"><svg class="w-4 h-4 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></span>'
											}
										</div>
									</div>
									<div class="flex items-center justify-between">
										<div class="flex-1">
											<p class="text-sm text-gray-500">
												${new Date(story.timestamp).toLocaleString('tr-TR', {
													hour: '2-digit',
													minute: '2-digit',
													day: '2-digit',
													month: '2-digit'
												})}
											</p>
										</div>
										<button 
											onclick="downloadStory('${story.url}')"
											class="ml-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition duration-200 flex items-center space-x-1"
										>
											<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
											</svg>
											<span>İndir</span>
										</button>
									</div>
								</div>
							`;
							
							storyElement.innerHTML = contentHtml;
							storyList.appendChild(storyElement);
						});
					} else {
						showError(response.data.message || 'Story\'ler alınamadı');
					}
				} catch (error) {
					console.error('Story fetch error:', error);
					throw new Error(error.response?.data?.detail || 'Story\'ler alınamadı');
				} finally {
					statusDiv.classList.add('hidden');
				}
			}
			
			function downloadStory(url) {
				downloadMedia(url);
			}

			function downloadMedia(url) {
				window.location.href = `/api/download-media?url=${encodeURIComponent(url)}`;
			}

			// Manuel indirme linki için click event'i
			downloadLink.addEventListener("click", (e) => {
				e.preventDefault();
				const url = downloadLink.href;
				downloadMedia(url);
			});

			// URL input değişikliğini dinle
			urlInput.addEventListener('input', (e) => {
				// URL input değiştiğinde hiçbir şey yapma, sadece input'u güncelle
				const url = e.target.value.trim();
				document.getElementById('download-btn').disabled = !url;
			});

			document.getElementById('download-btn').addEventListener('click', async function() {
				const url = document.getElementById('instagram-url').value.trim();
				const mediaType = document.querySelector('input[name="type"]:checked').value;
				
				if (!url) {
					showError('URL giriniz');
					return;
				}

				// Hata mesajını ve story seçim alanını gizle
				hideError();
				document.getElementById('story-selector').style.display = 'none';
				
				try {
					if (mediaType === 'story') {
						// Story seçildiğinde ve butona basıldığında story'leri getir
						const username = extractUsername(url);
						if (!username) {
							showError('Geçerli bir Instagram URL\'si giriniz');
							return;
						}
						
						showLoading('Story\'ler kontrol ediliyor...');
						await fetchStories(username);
						hideLoading();
					} else {
						// Story dışındaki medyalar için direkt indirmeye başla
						showLoading('İndiriliyor...');
						await downloadMedia(url);
						hideLoading();
					}
				} catch (error) {
					hideLoading();
					showError(error.message || 'Bir hata oluştu');
				}
			});

			function showError(message) {
				errorMessage.textContent = message;
				statusDiv.classList.add("hidden");
				resultDiv.classList.add("hidden");
				errorDiv.classList.remove("hidden");
			}

			function hideError() {
				errorMessage.textContent = '';
				statusDiv.classList.add("hidden");
				resultDiv.classList.add("hidden");
				errorDiv.classList.add("hidden");
			}

			function showLoading(message) {
				// Loading işlemleri burada yapılabilir
				console.log(message);
			}

			function hideLoading() {
				// Loading işlemleri burada yapılabilir
				console.log('Loading tamamlandı');
			}

			function displayStories(stories) {
				// Story'lerin görüntülenmesi için gerekli işlemler burada yapılabilir
				console.log('Story\'ler:', stories);
			}
		</script>
	</body>
</html>
